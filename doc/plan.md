# å¼€å‘è®¡åˆ’

å¼€å‘ä¸€ä¸ª SSO å•ç‚¹ç™»å½•ç³»ç»Ÿï¼Œæ”¯æŒå¦‚ä¸‹åŠŸèƒ½ï¼š

1. ç³»ç»Ÿè‡ªèº«çš„å¸å·ç³»ç»Ÿï¼šæ³¨å†Œã€ç™»å½•ã€ä¿®æ”¹å¯†ç ã€å¿˜è®°å¯†ç 
   a. ç™»å½•æ—¶é€‰æ‹©æ‰‹æœº+éªŒè¯ç ç™»å½•ï¼Œè¿˜æ˜¯é‚®ç®±+éªŒè¯ç ç™»å½•ï¼Œå¦‚æœç™»å½•æ—¶å‘ç°æ²¡æœ‰å¯¹åº”çš„å¸å·ï¼Œè‡ªåŠ¨æ³¨å†Œä¸€ä¸ªå¸å·
   b. ç”¨æˆ·å¸å·ä¿¡æ¯ä¸€ä¸ªè¡¨ï¼Œä¸»é”® user_id ç±»å‹ uuidï¼Œç”¨æˆ·ä¿¡æ¯å­—æ®µï¼š æ˜µç§°ã€ç±»å‹ï¼šæ‰‹æœºæ³¨å†Œã€é‚®ç®±æ³¨å†Œã€ä¸‰æ–¹ç¤¾åŒºæ³¨å†Œã€çŠ¶æ€ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´
   c. å¦‚æœæ˜¯æ‰‹æœºæ³¨å†Œï¼Œå­˜åœ¨æ‰‹æœºå·ç +ç”¨æˆ· user_id çš„è®°å½•è¡¨ï¼Œä¸»é”®æ˜¯æ‰‹æœºå·ç ï¼Œæ˜¯å¦éªŒè¯å­—æ®µï¼ŒéªŒè¯æ—¶é—´å­—æ®µï¼Œå¦å¤–åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´å­—æ®µ
   d. å¦‚æœæ˜¯é‚®ç®±æ³¨å†Œï¼Œå­˜åœ¨é‚®ç®±+ç”¨æˆ· user_id çš„è®°å½•è¡¨ï¼Œä¸»é”®æ˜¯é‚®ç®±ï¼Œæ˜¯å¦éªŒè¯å­—æ®µï¼ŒéªŒè¯æ—¶é—´å­—æ®µï¼Œå¦å¤–åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´å­—æ®µ
   e. ç”¨æˆ·æ‰©å±•ä¿¡æ¯è¡¨ï¼Œä¸»é”® user_idï¼Œæ‰©å±•ä¿¡æ¯å­—æ®µï¼šå¤´åƒã€æ€§åˆ«ã€å¹´é¾„ã€åœ°å€ç­‰
2. ä¸‰æ–¹ç¤¾åŒºå¸å·ç™»å½•åˆ›å»ºå¸å·ç³»ç»Ÿ
   a. æ”¯æŒä¸‰æ–¹ç¤¾åŒºå¸å·ç™»å½•ï¼Œå¦‚å¾®ä¿¡ã€QQã€å¾®åšã€è‹¹æœã€è°·æ­Œã€GitHub ç­‰
   b. ç™»å½•æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æ–°ç”¨æˆ·ï¼Œå¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå¸å·ï¼Œå¹¶ä¸”ç»‘å®šä¸‰æ–¹ç¤¾åŒºå¸å·
   c. ç™»å½•æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æ—§ç”¨æˆ·ï¼Œå¦‚æœæ˜¯æ—§ç”¨æˆ·ï¼Œç›´æ¥ç™»å½•
   d. ä¸‰æ–¹ç™»å½•å¸å·è¡¨ï¼Œç±»ä¼¼ç³»ç»Ÿè‡ªèº«å¸å·ç³»ç»Ÿé‡Œé¢çš„æ‰‹æœºæ³¨å†Œã€é‚®ç®±æ³¨å†Œï¼Œä¸»é”®æ˜¯ä¸‰æ–¹ç¤¾åŒºç±»å‹+ä¸‰æ–¹ç¤¾åŒºå¸å·ï¼Œå­—æ®µï¼šç”¨æˆ· user_idã€ä¸‰æ–¹ç¤¾åŒºç±»å‹ã€ä¸‰æ–¹ç¤¾åŒºå¸å·ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´
3. æ‰‹æœºæ³¨å†Œã€é‚®ç®±æ³¨å†Œã€ä¸‰æ–¹ç¤¾åŒºæ³¨å†Œä»»æ„ä¸€ä¸ªå¸å·æˆåŠŸåï¼Œå¯ä»¥æ”¯æŒç»‘å®šå…¶ä»–ä¸‰æ–¹ç¤¾åŒºå¸å·ã€æ‰‹æœºæ³¨å†Œã€é‚®ç®±æ³¨å†Œï¼Œå¦‚æœå†²çªåˆ™æç¤ºå¸å·å·²ç»å­˜åœ¨æ— æ³•ç»‘å®š
4. å¯¹å·±æ–¹å¹³å°çš„ OAuth2 è®¤è¯ï¼Œæ³¨å†Œå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¿¡æ¯è¡¨ï¼Œä¸»é”®æ˜¯å®¢æˆ·ç«¯ IDï¼Œå­—æ®µï¼šå®¢æˆ·ç«¯ IDã€å®¢æˆ·ç«¯åç§°ã€å®¢æˆ·ç«¯ç±»å‹ã€å®¢æˆ·ç«¯å¯†é’¥ã€å›è°ƒ URLã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´
5. ç®¡ç†åå°ï¼Œç”¨æˆ·ç®¡ç†ã€å®¢æˆ·ç«¯ç®¡ç†ã€ä¸‰æ–¹ç¤¾åŒºç®¡ç†
6. RESTful API æ¥å£
7. React.js å‰æ®µå’Œåç«¯åˆ†ç¦»
8. æ•°æ®åº“: MySQL, Redis
9. ç¼“å­˜: Redis, bigcache
10. GORM æ¡†æ¶
11. åç»­æ‰©å±•ï¼Œå¼€å‘å¯¹å…¶ä»–å¼€å‘è€…æä¾›çš„ä¸‰æ–¹ç¤¾åŒºçš„ç™»å½•æ”¯æŒï¼Œå…¶ä»–å¼€å‘è€…æ³¨å†Œå¼€å‘è€…å¸å·åï¼Œå¯ä»¥è‡ªå·±ç»´æŠ¤è‡ªå·±çš„ OAuth2 è®¤è¯å®¢æˆ·ç«¯åˆ—è¡¨


è¯¦ç»†å®ç°è®¡åˆ’
ğŸ”¥ ç¬¬ä¸€é˜¶æ®µï¼šå®Œå–„æ•°æ®æ¨¡å‹å’Œæ•°æ®åº“ç»“æ„ï¼ˆé¢„è®¡2-3å¤©ï¼‰
1.1 ä¿®å¤ç°æœ‰æ¨¡å‹
æ–‡ä»¶ï¼š internal/domain/account/phone.go å’Œ email.go

// éœ€è¦æ·»åŠ çš„å­—æ®µ
IsVerified  bool       `gorm:"column:is_verified;default:0" json:"is_verified"`
VerifiedAt  *time.Time `gorm:"column:verified_at;type:timestamp" json:"verified_at"`
1.2 åˆ›å»ºæ–°çš„æ•°æ®æ¨¡å‹
éœ€è¦åˆ›å»ºçš„æ–‡ä»¶ï¼š

internal/domain/account/profile.go - ç”¨æˆ·æ‰©å±•ä¿¡æ¯
internal/domain/account/social.go - ä¸‰æ–¹ç¤¾åŒºè´¦å·
internal/domain/oauth2/client.go - OAuth2å®¢æˆ·ç«¯
internal/domain/verification/code.go - éªŒè¯ç è¡¨
1.3 å…·ä½“æ¨¡å‹è®¾è®¡
ç”¨æˆ·æ‰©å±•ä¿¡æ¯è¡¨ï¼š

type Profile struct {
    AccountID uuid.UUID `gorm:"primaryKey;column:account_id;type:uuid"`
    Avatar    string    `gorm:"column:avatar;type:varchar(255)"`
    Gender    int8      `gorm:"column:gender;default:0"` // 0:æœªçŸ¥ 1:ç”· 2:å¥³
    Age       int       `gorm:"column:age"`
    Address   string    `gorm:"column:address;type:varchar(500)"`
    CreatedAt time.Time `gorm:"column:created_at;type:timestamp;default:CURRENT_TIMESTAMP"`
    UpdatedAt time.Time `gorm:"column:updated_at;type:timestamp;default:CURRENT_TIMESTAMP"`
}
ä¸‰æ–¹ç¤¾åŒºè´¦å·è¡¨ï¼š

type Social struct {
    ID         string     `gorm:"primaryKey;column:id;type:varchar(128)"` // å¹³å°ç±»å‹+ç¤¾åŒºè´¦å·ID
    AccountID  *uuid.UUID `gorm:"column:account_id;type:uuid"`
    Platform   string     `gorm:"column:platform;type:varchar(32)"` // wechat, qq, githubç­‰
    SocialID   string     `gorm:"column:social_id;type:varchar(64)"`
    SocialName string     `gorm:"column:social_name;type:varchar(128)"`
    CreatedAt  time.Time  `gorm:"column:created_at;type:timestamp;default:CURRENT_TIMESTAMP"`
    UpdatedAt  time.Time  `gorm:"column:updated_at;type:timestamp;default:CURRENT_TIMESTAMP"`
}
OAuth2å®¢æˆ·ç«¯è¡¨ï¼š

type Client struct {
    ID           string    `gorm:"primaryKey;column:id;type:varchar(64)"`
    Name         string    `gorm:"column:name;type:varchar(128)"`
    Secret       string    `gorm:"column:secret;type:varchar(128)"`
    RedirectURIs string    `gorm:"column:redirect_uris;type:text"` // JSONæ•°ç»„
    Scopes       string    `gorm:"column:scopes;type:varchar(255)"`
    GrantTypes   string    `gorm:"column:grant_types;type:varchar(255)"`
    CreatedAt    time.Time `gorm:"column:created_at;type:timestamp;default:CURRENT_TIMESTAMP"`
    UpdatedAt    time.Time `gorm:"column:updated_at;type:timestamp;default:CURRENT_TIMESTAMP"`
}
éªŒè¯ç è¡¨ï¼š

type VerificationCode struct {
    ID        string    `gorm:"primaryKey;column:id;type:varchar(64)"`
    Type      string    `gorm:"column:type;type:varchar(16)"` // phone, email
    Target    string    `gorm:"column:target;type:varchar(255)"` // æ‰‹æœºå·æˆ–é‚®ç®±
    Code      string    `gorm:"column:code;type:varchar(16)"`
    Purpose   string    `gorm:"column:purpose;type:varchar(32)"` // login, register, reset_password
    ExpiresAt time.Time `gorm:"column:expires_at;type:timestamp"`
    UsedAt    *time.Time `gorm:"column:used_at;type:timestamp"`
    CreatedAt time.Time `gorm:"column:created_at;type:timestamp;default:CURRENT_TIMESTAMP"`
}
ğŸ”¥ ç¬¬äºŒé˜¶æ®µï¼šå®Œå–„Repositoryå±‚ï¼ˆé¢„è®¡2å¤©ï¼‰
2.1 éœ€è¦åˆ›å»ºçš„Repositoryæ–‡ä»¶
internal/repository/account/profile.go
internal/repository/account/social.go
internal/repository/oauth2/client.go
internal/repository/verification/code.go
2.2 å®Œå–„ç°æœ‰Repository
æ‰©å±• internal/repository/account/phone.go å’Œ email.goï¼š

æ·»åŠ éªŒè¯çŠ¶æ€æ›´æ–°æ–¹æ³•
æ·»åŠ æŒ‰éªŒè¯çŠ¶æ€æŸ¥è¯¢æ–¹æ³•
æ·»åŠ éªŒè¯æ—¶é—´æ›´æ–°æ–¹æ³•
ğŸ”¥ ç¬¬ä¸‰é˜¶æ®µï¼šå®Œå–„Serviceå±‚ä¸šåŠ¡é€»è¾‘ï¼ˆé¢„è®¡3-4å¤©ï¼‰
3.1 è´¦æˆ·æœåŠ¡æ‰©å±•
æ–‡ä»¶ï¼š internal/service/account.go
éœ€è¦å®ç°çš„æ–¹æ³•ï¼š

RegisterByPhone(phone, code string) (*Account, error)
RegisterByEmail(email, code string) (*Account, error)
LoginByPhone(phone, code string) (*Account, error)
LoginByEmail(email, code string) (*Account, error)
BindPhone(accountID uuid.UUID, phone, code string) error
BindEmail(accountID uuid.UUID, email, code string) error
BindSocial(accountID uuid.UUID, platform, socialID string) error
3.2 æ–°å¢æœåŠ¡
éœ€è¦åˆ›å»ºçš„æœåŠ¡æ–‡ä»¶ï¼š

internal/service/verification.go - éªŒè¯ç æœåŠ¡
internal/service/oauth2.go - OAuth2æœåŠ¡
internal/service/social.go - ä¸‰æ–¹ç™»å½•æœåŠ¡
3.3 éªŒè¯ç æœåŠ¡æ ¸å¿ƒæ–¹æ³•
type VerificationService struct{}

func (s *VerificationService) SendPhoneCode(phone, purpose string) error
func (s *VerificationService) SendEmailCode(email, purpose string) error
func (s *VerificationService) VerifyCode(target, code, purpose string) (bool, error)
ğŸ”¥ ç¬¬å››é˜¶æ®µï¼šå®Œå–„Controllerå±‚APIæ¥å£ï¼ˆé¢„è®¡2-3å¤©ï¼‰
4.1 è´¦æˆ·ç›¸å…³API
æ–‡ä»¶ï¼š controller/account.go
éœ€è¦å®ç°çš„æ¥å£ï¼š

POST /api/auth/send-phone-code - å‘é€æ‰‹æœºéªŒè¯ç 
POST /api/auth/send-email-code - å‘é€é‚®ç®±éªŒè¯ç 
POST /api/auth/login-phone - æ‰‹æœºéªŒè¯ç ç™»å½•
POST /api/auth/login-email - é‚®ç®±éªŒè¯ç ç™»å½•
POST /api/auth/bind-phone - ç»‘å®šæ‰‹æœºå·
POST /api/auth/bind-email - ç»‘å®šé‚®ç®±
GET /api/user/profile - è·å–ç”¨æˆ·ä¿¡æ¯
PUT /api/user/profile - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
4.2 OAuth2ç›¸å…³API
éœ€è¦åˆ›å»ºï¼š controller/oauth2.go

GET /oauth2/authorize - æˆæƒé¡µé¢
POST /oauth2/authorize - å¤„ç†æˆæƒ
POST /oauth2/token - è·å–è®¿é—®ä»¤ç‰Œ
GET /oauth2/userinfo - è·å–ç”¨æˆ·ä¿¡æ¯
4.3 ä¸‰æ–¹ç™»å½•API
éœ€è¦åˆ›å»ºï¼š controller/social.go

GET /auth/social/{platform} - è·³è½¬åˆ°ä¸‰æ–¹ç™»å½•
GET /auth/social/{platform}/callback - ä¸‰æ–¹ç™»å½•å›è°ƒ
ğŸ”¥ ç¬¬äº”é˜¶æ®µï¼šé›†æˆå¤–éƒ¨æœåŠ¡ï¼ˆé¢„è®¡2-3å¤©ï¼‰
5.1 Redisç¼“å­˜é›†æˆ
æ·»åŠ Redisä¾èµ–åˆ°go.mod
åˆ›å»º internal/cache/redis.go
ç”¨äºå­˜å‚¨éªŒè¯ç ã€ä¼šè¯ä¿¡æ¯ç­‰
5.2 æ¶ˆæ¯å‘é€æœåŠ¡
çŸ­ä¿¡å‘é€æœåŠ¡é›†æˆï¼ˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ï¼‰
é‚®ä»¶å‘é€æœåŠ¡é›†æˆï¼ˆSMTPï¼‰
å®Œå–„ internal/task/account/ ä¸‹çš„å‘é€ä»»åŠ¡
5.3 ä¸‰æ–¹ç™»å½•SDKé›†æˆ
å¾®ä¿¡ç™»å½•SDK
GitHub OAuth2
QQç™»å½•SDK
ğŸ”¥ ç¬¬å…­é˜¶æ®µï¼šä¸­é—´ä»¶å’Œå®‰å…¨ï¼ˆé¢„è®¡1-2å¤©ï¼‰
6.1 è®¤è¯ä¸­é—´ä»¶
æ–‡ä»¶ï¼š middleware/auth.go

JWTä»¤ç‰ŒéªŒè¯
OAuth2ä»¤ç‰ŒéªŒè¯
ç”¨æˆ·æƒé™æ£€æŸ¥
6.2 å®‰å…¨ä¸­é—´ä»¶
CORSå¤„ç†
è¯·æ±‚é™æµ
å‚æ•°éªŒè¯
ğŸ”¥ ç¬¬ä¸ƒé˜¶æ®µï¼šå‰ç«¯å¼€å‘ï¼ˆé¢„è®¡5-7å¤©ï¼‰
7.1 React.jsé¡¹ç›®æ­å»º
åˆ›å»º web/ ç›®å½•
åˆå§‹åŒ–Reacté¡¹ç›®
é…ç½®è·¯ç”±ã€çŠ¶æ€ç®¡ç†
7.2 æ ¸å¿ƒé¡µé¢å¼€å‘
ç™»å½•é¡µé¢
æ³¨å†Œé¡µé¢
ç”¨æˆ·ä¸­å¿ƒ
OAuth2æˆæƒé¡µé¢
ğŸ”¥ ç¬¬å…«é˜¶æ®µï¼šç®¡ç†åå°ï¼ˆé¢„è®¡3-4å¤©ï¼‰
8.1 ç®¡ç†API
éœ€è¦åˆ›å»ºï¼š controller/admin.go

ç”¨æˆ·ç®¡ç†æ¥å£
å®¢æˆ·ç«¯ç®¡ç†æ¥å£
ç³»ç»Ÿç»Ÿè®¡æ¥å£
8.2 ç®¡ç†å‰ç«¯
ç”¨æˆ·åˆ—è¡¨å’Œç®¡ç†
OAuth2å®¢æˆ·ç«¯ç®¡ç†
ç³»ç»Ÿç›‘æ§é¢æ¿
å®æ–½å»ºè®®
ä¼˜å…ˆçº§æ’åºï¼šå»ºè®®ä¸¥æ ¼æŒ‰ç…§é˜¶æ®µé¡ºåºæ‰§è¡Œï¼Œæ¯ä¸ªé˜¶æ®µå®Œæˆåè¿›è¡Œæµ‹è¯•
æµ‹è¯•é©±åŠ¨ï¼šæ¯ä¸ªåŠŸèƒ½å¼€å‘å®Œæˆåç«‹å³ç¼–å†™å•å…ƒæµ‹è¯•
æ–‡æ¡£åŒæ­¥ï¼šåŠæ—¶æ›´æ–°APIæ–‡æ¡£å’Œä½¿ç”¨è¯´æ˜
ä»£ç å®¡æŸ¥ï¼šæ¯ä¸ªé˜¶æ®µå®Œæˆåè¿›è¡Œä»£ç å®¡æŸ¥